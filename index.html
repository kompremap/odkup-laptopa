<script>
  document.addEventListener('DOMContentLoaded', () => {
    const questions = document.querySelectorAll('.question');
    const summary = document.getElementById('offerSummary');
    let currentStep = 0;
    const form = document.getElementById('buyback-form');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnCalc = document.getElementById('btn-calculate');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnBack = document.getElementById('btn-back');
    const offerCode = document.getElementById('offerCode');
    const finalPrice = document.getElementById('finalPrice');

    const priceMap = {
      '25MB': 99, '25MW': 98, '25MBZ': 90,
      '25WB': 89, '25WBW': 87, '25WBZ': 85,
      '20MB': 78, '20MW': 75, '20MBZ': 69,
      '20WB': 79, '20WBW': 79, '20WBZ': 79
    };

    function showStep(i) {
      [...questions, summary].forEach(el => el.classList.remove('active'));
      if (questions[i]) questions[i].classList.add('active');
      btnPrev.style.display = i > 0 ? 'inline-block' : 'none';
      btnNext.style.display = i < questions.length - 1 ? 'inline-block' : 'none';
      btnCalc.style.display = i === questions.length - 1 ? 'inline-block' : 'none';
    }

    showStep(0);

    btnNext.addEventListener('click', () => {
      const inputs = questions[currentStep].querySelectorAll('input');
      if (![...inputs].some(i => i.checked)) return alert('Proszę zaznaczyć odpowiedź.');

      // Ukryj komunikaty specjalne, jeśli wcześniej się pojawiły
      document.getElementById('businessMessage').classList.remove('active');
      document.getElementById('valueEstimate').classList.remove('active');

      // Logika zatrzymująca formularz
      if (currentStep === 0 && form.clientType.value === 'business') {
        document.getElementById('businessMessage').classList.add('active');
        return;
      }

      if (currentStep === 3 && form.power.value === 'nie') {
        document.getElementById('valueEstimate').classList.add('active');
        return;
      }

      currentStep++;
      showStep(currentStep);
    });

    btnPrev.addEventListener('click', () => {
      currentStep--;
      showStep(currentStep);
    });

    btnCalc.addEventListener('click', () => {
      const yearCode = form.year.value === '2021-2025' ? '25' : '20';
      const caseCode = form.case.value === 'jak nowa' ? 'M' : 'W';
      const extras = [...form.querySelectorAll('input[name="extras"]:checked')].map(e => e.value);
      let extrasCode = extras.includes('bateria') && extras.includes('zasilacz') ? 'Z' :
                       extras.includes('bateria') ? 'B' : 'W';
      const code = yearCode + caseCode + extrasCode;
      offerCode.innerText = code;
      finalPrice.innerText = (priceMap[code] || 0) + ' zł';
      showStep(questions.length); // pokazanie podsumowania
    });

    btnRefresh.addEventListener('click', () => location.reload());
    btnBack.addEventListener('click', () => location.href = 'https://kompre.pl');
  });
</script>
